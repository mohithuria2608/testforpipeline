import * as Joi from '@hapi/joi';
import * as Router from 'koa-router'
import { Aerospike } from '../../databases/aerospike'
import { validate } from '../../middlewares'


export default (router: Router) => {
    router
        .post('/create-index',
            validate({
                body: {
                    set: Joi.string().required(),
                    bin: Joi.string().required(),
                    type: Joi.string().valid('NUMERIC', 'STRING', 'GEO2DSPHERE').required(),
                }
            }),
            async (ctx) => {
                try {
                    let payload = { ...ctx.request.body };

                    let createIndexArg: IAerospike.CreateIndex = {
                        set: payload.set,
                        bin: payload.bin,
                        index: 'idx_' + payload.set + '_' + payload.bin,
                        type: payload.type
                    }
                    await Aerospike.indexCreate(createIndexArg)
                    ctx.body = {}
                }
                catch (error) {
                    throw error
                }
            })

        .post('/register-ufd',
            async (ctx) => {
                try {
                    Aerospike.udfRegister({ module: __dirname + '/../../../lua/user.lua' })
                    ctx.body = {}
                }
                catch (error) {
                    throw error
                }
            })

        .post('/test',
            async (ctx) => {
                try {
                    const aerospike = require('aerospike');
                    let GeoJSON = aerospike.GeoJSON;
                    let polygon = new GeoJSON({
                        "type": "Polygon",
                        "coordinates": [
                            [
                                [
                                    55.3366541862488,
                                    25.2316916616407
                                ],
                                [
                                    55.3373193740845,
                                    25.2311287579901
                                ],
                                [
                                    55.3381776809692,
                                    25.2318469449478
                                ],
                                [
                                    55.3416109085083,
                                    25.2291488692754
                                ],
                                [
                                    55.3431987762451,
                                    25.2284694882679
                                ],
                                [
                                    55.3440356254578,
                                    25.2267224911057
                                ],
                                [
                                    55.3448295593262,
                                    25.2256160465891
                                ],
                                [
                                    55.3445720672607,
                                    25.225460755325
                                ],
                                [
                                    55.3448724746704,
                                    25.2245872382703
                                ],
                                [
                                    55.3452587127686,
                                    25.223422539105
                                ],
                                [
                                    55.3453230857849,
                                    25.2225490074118
                                ],
                                [
                                    55.3451943397522,
                                    25.2220442973519
                                ],
                                [
                                    55.3453660011292,
                                    25.221811353541
                                ],
                                [
                                    55.3450226783752,
                                    25.2206272156048
                                ],
                                [
                                    55.3449583053589,
                                    25.2203554446161
                                ],
                                [
                                    55.3451299667358,
                                    25.2203166201396
                                ],
                                [
                                    55.3448724746704,
                                    25.2195983650888
                                ],
                                [
                                    55.3447008132935,
                                    25.2195983650888
                                ],
                                [
                                    55.3440141677856,
                                    25.2186277434178
                                ],
                                [
                                    55.3434991836548,
                                    25.2181618422651
                                ],
                                [
                                    55.343177318573,
                                    25.2180841918995
                                ],
                                [
                                    55.3387141227722,
                                    25.2143569160697
                                ],
                                [
                                    55.3372979164124,
                                    25.2132891858092
                                ],
                                [
                                    55.3363108634949,
                                    25.2116196251695
                                ],
                                [
                                    55.3358817100525,
                                    25.2102606635532
                                ],
                                [
                                    55.3357100486755,
                                    25.208862858631
                                ],
                                [
                                    55.3354525566101,
                                    25.2079309797643
                                ],
                                [
                                    55.3347229957581,
                                    25.2070185081273
                                ],
                                [
                                    55.3341865539551,
                                    25.2062031021536
                                ],
                                [
                                    55.3340685367584,
                                    25.2058973235052
                                ],
                                [
                                    55.3340631723404,
                                    25.2058342262282
                                ],
                                [
                                    55.3336608409882,
                                    25.2055527149015
                                ],
                                [
                                    55.3334784507751,
                                    25.2055527149015
                                ],
                                [
                                    55.3331243991852,
                                    25.2056643487814
                                ],
                                [
                                    55.332727432251,
                                    25.2053537151226
                                ],
                                [
                                    55.3331351280212,
                                    25.2049362998955
                                ],
                                [
                                    55.3333014249802,
                                    25.2050673490163
                                ],
                                [
                                    55.3333979845047,
                                    25.2049605682618
                                ],
                                [
                                    55.332904458046,
                                    25.2045916885712
                                ],
                                [
                                    55.3327810764313,
                                    25.2047178843806
                                ],
                                [
                                    55.3325182199478,
                                    25.2049751292793
                                ],
                                [
                                    55.3321802616119,
                                    25.2051935443326
                                ],
                                [
                                    55.3317511081696,
                                    25.2053973980288
                                ],
                                [
                                    55.331295132637,
                                    25.205523593003
                                ],
                                [
                                    55.3304100036621,
                                    25.2055721294967
                                ],
                                [
                                    55.3285592794418,
                                    25.205586690441
                                ],
                                [
                                    55.327695608139,
                                    25.2056594951365
                                ],
                                [
                                    55.326241850853,
                                    25.2055818367931
                                ],
                                [
                                    55.3249758481979,
                                    25.2055915440887
                                ],
                                [
                                    55.3236132860184,
                                    25.2056352269095
                                ],
                                [
                                    55.3223794698715,
                                    25.2055721294967
                                ],
                                [
                                    55.3212529420853,
                                    25.2055430076028
                                ],
                                [
                                    55.3202337026596,
                                    25.205586690441
                                ],
                                [
                                    55.3194129467011,
                                    25.2056740560704
                                ],
                                [
                                    55.3184902667999,
                                    25.2057517143551
                                ],
                                [
                                    55.3177016973495,
                                    25.205780836199
                                ],
                                [
                                    55.3174388408661,
                                    25.2057565679962
                                ],
                                [
                                    55.3172993659973,
                                    25.2055672758482
                                ],
                                [
                                    55.3167414665222,
                                    25.2053051785419
                                ],
                                [
                                    55.3162908554077,
                                    25.2051935443326
                                ],
                                [
                                    55.3155881166458,
                                    25.2050673490163
                                ],
                                [
                                    55.3148317337036,
                                    25.2048198116696
                                ],
                                [
                                    55.3142255544662,
                                    25.2044315167785
                                ],
                                [
                                    55.313635468483,
                                    25.2038490721195
                                ],
                                [
                                    55.3130614757538,
                                    25.2028006647111
                                ],
                                [
                                    55.312734246254,
                                    25.2021356979256
                                ],
                                [
                                    55.3122889995575,
                                    25.2014173355652
                                ],
                                [
                                    55.3117740154266,
                                    25.2008542918334
                                ],
                                [
                                    55.3110927343369,
                                    25.2003252225056
                                ],
                                [
                                    55.3106099367142,
                                    25.2000922371184
                                ],
                                [
                                    55.3100681304932,
                                    25.2000388445711
                                ],
                                [
                                    55.3092741966248,
                                    25.2001067987182
                                ],
                                [
                                    55.3094297647476,
                                    25.2012086213821
                                ],
                                [
                                    55.309687256813,
                                    25.2019803766933
                                ],
                                [
                                    55.3099822998047,
                                    25.2027327120675
                                ],
                                [
                                    55.3102022409439,
                                    25.2031452811053
                                ],
                                [
                                    55.3119134902954,
                                    25.205465349185
                                ],
                                [
                                    55.3121548891068,
                                    25.2058390798661
                                ],
                                [
                                    55.3124123811722,
                                    25.2063778324649
                                ],
                                [
                                    55.3125357627869,
                                    25.2066544882783
                                ],
                                [
                                    55.3129541873932,
                                    25.2078387621968
                                ],
                                [
                                    55.31309902668,
                                    25.2087172530284
                                ],
                                [
                                    55.3136515617371,
                                    25.2120709912063
                                ],
                                [
                                    55.3142523765564,
                                    25.2151698407813
                                ],
                                [
                                    55.3208988904953,
                                    25.2142258769511
                                ],
                                [
                                    55.3218296170235,
                                    25.2196638817725
                                ],
                                [
                                    55.3151643276215,
                                    25.2206078034115
                                ],
                                [
                                    55.315443277359,
                                    25.2221122392127
                                ],
                                [
                                    55.3156578540802,
                                    25.2234419508491
                                ],
                                [
                                    55.3156685829163,
                                    25.224373710925
                                ],
                                [
                                    55.3156042098999,
                                    25.2250239975819
                                ],
                                [
                                    55.3154754638672,
                                    25.225761631969
                                ],
                                [
                                    55.3153467178345,
                                    25.226431322472
                                ],
                                [
                                    55.3153359889984,
                                    25.2275474651153
                                ],
                                [
                                    55.3154540061951,
                                    25.22862477569
                                ],
                                [
                                    55.3155720233917,
                                    25.2291197530243
                                ],
                                [
                                    55.3169238567352,
                                    25.2284403718542
                                ],
                                [
                                    55.3210973739624,
                                    25.2263051491809
                                ],
                                [
                                    55.3220951557159,
                                    25.2259266285222
                                ],
                                [
                                    55.3230500221252,
                                    25.2257131035284
                                ],
                                [
                                    55.3243911266327,
                                    25.225460755325
                                ],
                                [
                                    55.3259038925171,
                                    25.2254704610349
                                ],
                                [
                                    55.3273093700409,
                                    25.2256160465891
                                ],
                                [
                                    55.3281891345978,
                                    25.2258101603903
                                ],
                                [
                                    55.3300559520721,
                                    25.2264410281044
                                ],
                                [
                                    55.331643819809,
                                    25.2274018818732
                                ],
                                [
                                    55.3333604335785,
                                    25.2286441866038
                                ],
                                [
                                    55.3351736068726,
                                    25.230264986976
                                ],
                                [
                                    55.3365576267242,
                                    25.231759598112
                                ],
                                [
                                    55.3366541862488,
                                    25.2316916616407
                                ]
                            ]
                        ]
                    })
                    Aerospike.put({
                        bins: {
                            "id": "cd4444c0-1c31-11ea-964e-c13f240dc3c5",
                            "storeId": 28,
                            "countryId": -1,
                            "provinceId": 7,
                            "menuId": 5,
                            "areaId": 520,
                            "streetId": 4,
                            "districtId": 1010,
                            "mapId": 349,
                            "name_en": "ABU KADRA - DUBAI",
                            "name_ar": "كنتاكى أبو خضرة  - دبى",
                            "phone1": "0551484072",
                            "phone2": "0551484079",
                            "services": {
                                "del": 0,
                                "tak": 0,
                                "din": 0
                            },
                            "active": 1,
                            "location": {
                                "description": "Dubai - Al Ain Rd - Dubai - United Arab Emirates",
                                "latitude": 25.1922898422229,
                                "longitude": 55.3089012183914
                            },
                            "address_en": "Dubai Al Ain Road, at the Emarat Petrol Station",
                            "address_ar": "طريق دبي العين ، داخل محطة بنزين إمارات",
                            "geoFence": polygon,
                            "startTime": "2014-08-03T04:30:00.000Z",
                            "endTime": "2014-08-02T21:30:59.000Z"
                        },
                        set: 'store',
                        key: "ef801b00-1abe-11ea-8153-7526aef7d0f7",
                        create: true
                    })

                    let res = await Aerospike.query({
                        set: "store",
                        geoWithin: {
                            bin: "geoFence",
                            lat: 55.329423,
                            lng: 25.2196954
                        }
                    })
                    // SELECT * FROM americana.store WHERE geoFence CONTAINS GeoJSON('{"type":"Point", "coordinates": [77.3651218, 28.5911163]}')
                    // await Aerospike.operationsOnMap({ set: 'user', key: '155e0680-19b5-11ea-bf45-d91ad9310ae6' }, [])

                    ctx.body = {}
                }
                catch (error) {
                    throw error
                }
            })
}






/**
 * @description : import data
 */
// 55.3366541862488,25.2316916616407
// 55.3373193740845,25.2311287579901
// 55.3381776809692,25.2318469449478
// 55.3416109085083,25.2291488692754
// 55.3431987762451,25.2284694882679
// 55.3440356254578,25.2267224911057
// 55.3448295593262,25.2256160465891
// 55.3445720672607,25.225460755325
// 55.3448724746704,25.2245872382703
// 55.3452587127686,25.223422539105
// 55.3453230857849,25.2225490074118
// 55.3451943397522,25.2220442973519
// 55.3453660011292,25.221811353541
// 55.3450226783752,25.2206272156048
// 55.3449583053589,25.2203554446161
// 55.3451299667358,25.2203166201396
// 55.3448724746704,25.2195983650888
// 55.3447008132935,25.2195983650888
// 55.3440141677856,25.2186277434178
// 55.3434991836548,25.2181618422651
// 55.343177318573,25.2180841918995
// 55.3387141227722,25.2143569160697
// 55.3372979164124,25.2132891858092
// 55.3363108634949,25.2116196251695
// 55.3358817100525,25.2102606635532
// 55.3357100486755,25.208862858631
// 55.3354525566101,25.2079309797643
// 55.3347229957581,25.2070185081273
// 55.3341865539551,25.2062031021536
// 55.3340685367584,25.2058973235052
// 55.3340631723404,25.2058342262282
// 55.3336608409882,25.2055527149015
// 55.3334784507751,25.2055527149015
// 55.3331243991852,25.2056643487814
// 55.332727432251,25.2053537151226
// 55.3331351280212,25.2049362998955
// 55.3333014249802,25.2050673490163
// 55.3333979845047,25.2049605682618
// 55.332904458046,25.2045916885712
// 55.3327810764313,25.2047178843806
// 55.3325182199478,25.2049751292793
// 55.3321802616119,25.2051935443326
// 55.3317511081696,25.2053973980288
// 55.331295132637,25.205523593003
// 55.3304100036621,25.2055721294967
// 55.3285592794418,25.205586690441
// 55.327695608139,25.2056594951365
// 55.326241850853,25.2055818367931
// 55.3249758481979,25.2055915440887
// 55.3236132860184,25.2056352269095
// 55.3223794698715,25.2055721294967
// 55.3212529420853,25.2055430076028
// 55.3202337026596,25.205586690441
// 55.3194129467011,25.2056740560704
// 55.3184902667999,25.2057517143551
// 55.3177016973495,25.205780836199
// 55.3174388408661,25.2057565679962
// 55.3172993659973,25.2055672758482
// 55.3167414665222,25.2053051785419
// 55.3162908554077,25.2051935443326
// 55.3155881166458,25.2050673490163
// 55.3148317337036,25.2048198116696
// 55.3142255544662,25.2044315167785
// 55.313635468483,25.2038490721195
// 55.3130614757538,25.2028006647111
// 55.312734246254,25.2021356979256
// 55.3122889995575,25.2014173355652
// 55.3117740154266,25.2008542918334
// 55.3110927343369,25.2003252225056
// 55.3106099367142,25.2000922371184
// 55.3100681304932,25.2000388445711
// 55.3092741966248,25.2001067987182
// 55.3094297647476,25.2012086213821
// 55.309687256813,25.2019803766933
// 55.3099822998047,25.2027327120675
// 55.3102022409439,25.2031452811053
// 55.3119134902954,25.205465349185
// 55.3121548891068,25.2058390798661
// 55.3124123811722,25.2063778324649
// 55.3125357627869,25.2066544882783
// 55.3129541873932,25.2078387621968
// 55.31309902668,25.2087172530284
// 55.3136515617371,25.2120709912063
// 55.3142523765564,25.2151698407813
// 55.3208988904953,25.2142258769511
// 55.3218296170235,25.2196638817725
// 55.3151643276215,25.2206078034115
// 55.315443277359,25.2221122392127
// 55.3156578540802,25.2234419508491
// 55.3156685829163,25.224373710925
// 55.3156042098999,25.2250239975819
// 55.3154754638672,25.225761631969
// 55.3153467178345,25.226431322472
// 55.3153359889984,25.2275474651153
// 55.3154540061951,25.22862477569
// 55.3155720233917,25.2291197530243
// 55.3169238567352,25.2284403718542
// 55.3210973739624,25.2263051491809
// 55.3220951557159,25.2259266285222
// 55.3230500221252,25.2257131035284
// 55.3243911266327,25.225460755325
// 55.3259038925171,25.2254704610349
// 55.3273093700409,25.2256160465891
// 55.3281891345978,25.2258101603903
// 55.3300559520721,25.2264410281044
// 55.331643819809,25.2274018818732
// 55.3333604335785,25.2286441866038
// 55.3351736068726,25.230264986976
// 55.3365576267242,25.231759598112
// 55.3366541862488,25.2316916616407
